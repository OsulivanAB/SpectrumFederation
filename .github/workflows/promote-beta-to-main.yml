name: Promote Beta to Main

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: main-release
  cancel-in-progress: false

jobs:
  pre-merge-validation:
    name: Pre-Merge Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout beta branch
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y luarocks
          sudo luarocks install luacheck
          pip install yamllint ruff

      - name: Run linters
        run: python3 .github/scripts/lint_all.py

      - name: Validate packaging
        run: python3 .github/scripts/validate_packaging.py

      - name: Verify beta version format
        run: |
          VERSION=$(grep -E '^## Version:' SpectrumFederation/SpectrumFederation.toc | head -n1 | sed 's/^## Version://i' | xargs)
          echo "Beta version: $VERSION"

          if [[ ! "$VERSION" =~ -beta\. ]]; then
            echo "::error ::Beta branch version must contain '-beta' suffix"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
        id: beta_version

  merge-beta-to-main:
    name: Merge Beta to Main
    runs-on: ubuntu-latest
    needs: pre-merge-validation
    outputs:
      stable_version: ${{ steps.remove_beta.outputs.stable_version }}
      interface: ${{ steps.blizzard.outputs.interface }}

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch beta branch
        run: git fetch origin beta:beta

      - name: Merge beta into main
        run: |
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Would merge beta into main with special handling for CHANGELOG.md and README.md"
            git merge --no-commit --no-ff beta || true
            git merge --abort || true
          else
            # Merge beta into main, using 'ours' strategy for CHANGELOG.md and README.md
            # This keeps main's versions, which will be regenerated by workflows
            git merge -X ours --no-commit --no-ff beta
            git checkout HEAD -- CHANGELOG.md README.md

            # Check for conflicts in other files
            if git diff --name-only --diff-filter=U | grep -v -E '(CHANGELOG\.md|README\.md)'; then
              echo "::error ::Merge conflicts detected in files other than CHANGELOG.md and README.md"
              echo "Please resolve conflicts manually and try again"
              git merge --abort
              exit 1
            fi

            git commit -m "chore: promote beta to main [skip ci]"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Remove -beta suffix from version
        id: remove_beta
        run: |
          BETA_VERSION=$(grep -E '^## Version:' SpectrumFederation/SpectrumFederation.toc | head -n1 | sed 's/^## Version://i' | xargs)
          STABLE_VERSION=$(echo "$BETA_VERSION" | sed 's/-beta\.[0-9]*$//')

          echo "Beta version: $BETA_VERSION"
          echo "Stable version: $STABLE_VERSION"
          echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Would update TOC version to $STABLE_VERSION"
          else
            sed -i "s/^## Version:.*$/## Version: $STABLE_VERSION/" SpectrumFederation/SpectrumFederation.toc
            git add SpectrumFederation/SpectrumFederation.toc
            git commit -m "chore: update version to $STABLE_VERSION [skip ci]"
          fi

      - name: Query Blizzard API for live Interface version
        id: blizzard
        run: |
          INTERFACE=$(python3 .github/scripts/blizzard_api.py --environment live --output interface)
          echo "interface=$INTERFACE" >> $GITHUB_OUTPUT
          echo "Live Interface version: $INTERFACE"

      - name: Update Interface version in TOC
        run: |
          INTERFACE="${{ steps.blizzard.outputs.interface }}"

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Would update TOC Interface to $INTERFACE"
          else
            sed -i "s/^## Interface:.*$/## Interface: $INTERFACE/" SpectrumFederation/SpectrumFederation.toc
            git add SpectrumFederation/SpectrumFederation.toc
            git commit -m "chore: update Interface to $INTERFACE [skip ci]" || echo "No Interface changes"
          fi

      - name: Push changes to main
        if: ${{ !inputs.dry_run }}
        run: git push origin main

  update-changelog-main:
    name: Update Changelog for Main
    runs-on: ubuntu-latest
    needs: merge-beta-to-main

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Update CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: main
        run: |
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Would update CHANGELOG.md for main branch"
          else
            python3 .github/scripts/update_changelog.py
          fi

      - name: Commit changelog changes
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet CHANGELOG.md; then
            echo "No changelog changes to commit"
          else
            git add CHANGELOG.md
            git commit -m "docs: update changelog for ${{ needs.merge-beta-to-main.outputs.stable_version }} [skip ci]"
            git pull --rebase origin main
            git push
          fi

  update-readme-main:
    name: Update README for Main
    runs-on: ubuntu-latest
    needs: [merge-beta-to-main, update-changelog-main]

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Update README badges
        run: |
          VERSION="${{ needs.merge-beta-to-main.outputs.stable_version }}"
          INTERFACE="${{ needs.merge-beta-to-main.outputs.interface }}"

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Would update README badges:"
            echo "  Version: $VERSION"
            echo "  Interface: $INTERFACE"
          else
            # Escape hyphens for shields.io (- becomes --)
            VERSION_ESCAPED="${VERSION//-/--}"

            # Update version badge (match between Version- and - at end)
            sed -i 's|badge/Version-[^)]*-brightgreen|badge/Version-'"${VERSION_ESCAPED}"'-brightgreen|g' README.md

            # Update interface badge
            sed -i "s|badge/Interface-[^-]*-|badge/Interface-${INTERFACE}-|g" README.md

            # Update track badge to Retail
            sed -i 's|badge/Track-[^-]*-|badge/Track-Retail-|g' README.md
          fi

      - name: Commit badge changes
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet README.md; then
            echo "No badge changes to commit"
          else
            git add README.md
            git commit -m "docs: update badges for ${{ needs.merge-beta-to-main.outputs.stable_version }} [skip ci]"
            git pull --rebase origin main
            git push
          fi

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [merge-beta-to-main, update-changelog-main, update-readme-main]

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.dry_run && 'beta' || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs dependencies
        run: pip install -r requirements-docs.txt

      - name: Build documentation
        run: |
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Testing documentation build from beta branch..."
            mkdocs build --clean --strict
            echo "[DRY RUN] Documentation build successful, but not deploying"
          else
            mkdocs build --clean --strict
          fi

      - name: Upload Pages artifact
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/

      - name: Deploy to GitHub Pages
        if: ${{ !inputs.dry_run }}
        id: deployment
        uses: actions/deploy-pages@v4

  publish-stable-release:
    name: Publish Stable Release
    runs-on: ubuntu-latest
    needs: [merge-beta-to-main, update-changelog-main, update-readme-main, deploy-docs]

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Package and publish release
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            python3 .github/scripts/publish_release.py "${{ needs.merge-beta-to-main.outputs.stable_version }}" --dry-run
          else
            python3 .github/scripts/publish_release.py "${{ needs.merge-beta-to-main.outputs.stable_version }}"
          fi

  fast-forward-beta:
    name: Fast-Forward Beta to Main
    runs-on: ubuntu-latest
    needs: [merge-beta-to-main, publish-stable-release]

    steps:
      - name: Checkout beta branch
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fast-forward beta to main
        run: |
          git fetch origin main:main

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "[DRY RUN] Would fast-forward beta to main"
            COMMITS=$(git rev-list --count main..beta)
            echo "Beta is $COMMITS commits ahead of main"
            git log --oneline main..beta | head -n 10
          else
            git merge --ff-only main
            git push origin beta
          fi

      - name: Verify branches are synced
        if: ${{ !inputs.dry_run }}
        run: |
          git fetch origin
          DIFF=$(git rev-list --count beta...main)

          if [[ $DIFF -ne 0 ]]; then
            echo "::warning ::Branches are not fully synced (diff: $DIFF commits)"
          else
            echo "âœ“ Beta and main branches are fully synced"
          fi

  summary:
    name: Promotion Summary
    runs-on: ubuntu-latest
    needs: [pre-merge-validation, merge-beta-to-main, update-changelog-main, update-readme-main, deploy-docs, publish-stable-release, fast-forward-beta]
    if: always()

    steps:
      - name: Summary
        run: |
          # Determine status emojis based on job results
          VALIDATION_STATUS="${{ needs.pre-merge-validation.result == 'success' && 'âœ…' || 'âŒ' }}"
          MERGE_STATUS="${{ needs.merge-beta-to-main.result == 'success' && 'âœ…' || 'âŒ' }}"
          CHANGELOG_STATUS="${{ needs.update-changelog-main.result == 'success' && 'âœ…' || 'âŒ' }}"
          README_STATUS="${{ needs.update-readme-main.result == 'success' && 'âœ…' || 'âŒ' }}"
          DOCS_STATUS="${{ needs.deploy-docs.result == 'success' && 'âœ…' || 'âŒ' }}"
          RELEASE_STATUS="${{ needs.publish-stable-release.result == 'success' && 'âœ…' || 'âŒ' }}"
          FASTFORWARD_STATUS="${{ needs.fast-forward-beta.result == 'success' && 'âœ…' || 'âŒ' }}"

          # Determine overall status
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            TITLE="## Promotion Failed âŒ"
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            TITLE="## Promotion Cancelled âš ï¸"
          else
            TITLE="## Promotion Complete ðŸŽ‰"
          fi

          echo "$TITLE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stable Version**: ${{ needs.merge-beta-to-main.outputs.stable_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Interface Version**: ${{ needs.merge-beta-to-main.outputs.interface }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- $VALIDATION_STATUS Pre-merge validation" >> $GITHUB_STEP_SUMMARY
          echo "- $MERGE_STATUS Merged beta â†’ main" >> $GITHUB_STEP_SUMMARY
          echo "- $CHANGELOG_STATUS Updated CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "- $README_STATUS Updated README badges" >> $GITHUB_STEP_SUMMARY
          echo "- $DOCS_STATUS Deployed documentation" >> $GITHUB_STEP_SUMMARY
          echo "- $RELEASE_STATUS Published stable release" >> $GITHUB_STEP_SUMMARY
          echo "- $FASTFORWARD_STATUS Fast-forwarded beta to main" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **This was a DRY RUN - no actual changes were made**" >> $GITHUB_STEP_SUMMARY
          fi
