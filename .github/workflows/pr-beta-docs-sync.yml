name: PR Beta Documentation Sync

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze and update documentation for'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: docs-sync-${{ github.event.inputs.pr_number }}
  cancel-in-progress: false

jobs:
  analyze-and-update-docs:
    name: Analyze Changes and Update Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.inputs.pr_number }}
            });

            // Verify PR targets beta
            if (pr.data.base.ref !== 'beta') {
              core.setFailed(`PR #${pr.data.number} does not target beta branch (targets ${pr.data.base.ref})`);
              return;
            }

            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('pr_title', pr.data.title);
            core.setOutput('pr_author', pr.data.user.login);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-details.outputs.head_ref }}
          fetch-depth: 0

      - name: Fetch beta branch for comparison
        run: |
          git fetch origin beta:beta

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Analyze documentation changes needed
        id: analyze-docs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
          HEAD_REF: ${{ steps.pr-details.outputs.head_ref }}
          BASE_REF: ${{ steps.pr-details.outputs.base_ref }}
        run: |
          python3 .github/scripts/analyze_docs_changes.py

      - name: Analyze copilot instructions changes needed
        id: analyze-copilot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
          HEAD_REF: ${{ steps.pr-details.outputs.head_ref }}
          BASE_REF: ${{ steps.pr-details.outputs.base_ref }}
        run: |
          python3 .github/scripts/analyze_copilot_instructions.py

      - name: Check if changes were made
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No documentation or copilot instruction changes needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected, will create PR"
          fi

      - name: Create commit with changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/ .github/copilot-instructions.md
          git commit -m "docs: sync documentation and copilot instructions with code changes

          This commit updates documentation and copilot instructions to reflect
          the code changes made in PR #${{ github.event.inputs.pr_number }}.

          Generated automatically by the docs-sync workflow."

      - name: Create branch and push
        if: steps.check-changes.outputs.has_changes == 'true'
        id: push-changes
        run: |
          BRANCH_NAME="docs-sync-pr-${{ github.event.inputs.pr_number }}-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

      - name: Create documentation update PR
        if: steps.check-changes.outputs.has_changes == 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: newPR } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'docs: sync documentation for PR #${{ github.event.inputs.pr_number }}',
              head: '${{ steps.push-changes.outputs.branch_name }}',
              base: '${{ steps.pr-details.outputs.head_ref }}',
              body: `## Documentation Sync

            This PR contains suggested documentation and copilot instruction updates based on the code changes in PR #${{ github.event.inputs.pr_number }}.

            ### What was analyzed:
            - Code changes between \`${{ steps.pr-details.outputs.head_ref }}\` and \`beta\`
            - Existing documentation in \`docs/\` directory
            - Copilot instructions in \`.github/copilot-instructions.md\`
            - Any documentation updates already made in the original PR

            ### Next steps:
            1. Review the suggested changes
            2. Make any necessary adjustments
            3. Merge this PR into the original PR branch
            4. The original PR #${{ github.event.inputs.pr_number }} will then include these documentation updates

            ---
            ðŸ¤– Generated automatically by the documentation sync workflow
            `
            });

            core.setOutput('pr_number', newPR.number);
            core.setOutput('pr_url', newPR.html_url);

      - name: Comment on original PR
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.pr_number }},
              body: `## ðŸ“š Documentation Sync Complete

            I've analyzed your code changes and created PR #${{ steps.create-pr.outputs.pr_number }} with suggested documentation updates.

            ### What I did:
            âœ… Analyzed code changes vs beta branch
            âœ… Cross-referenced with existing documentation
            âœ… Checked copilot instructions for needed updates
            âœ… Created PR targeting your branch: \`${{ steps.pr-details.outputs.head_ref }}\`

            ### What you should do:
            1. Review the changes in PR #${{ steps.create-pr.outputs.pr_number }}
            2. Make any adjustments if needed
            3. Merge it into your branch
            4. Your documentation will then be in sync! ðŸŽ‰

            [View Documentation PR â†’](${{ steps.create-pr.outputs.pr_url }})

            ---
            ðŸ¤– Triggered by the \`pr-beta-docs-sync\` workflow
            `
            });

      - name: Comment if no changes needed
        if: steps.check-changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.pr_number }},
              body: `## ðŸ“š Documentation Sync Complete

            I've analyzed your code changes and determined that no documentation updates are needed! âœ¨

            ### What I checked:
            âœ… Code changes vs beta branch
            âœ… Existing documentation in \`docs/\`
            âœ… Copilot instructions in \`.github/copilot-instructions.md\`

            Your documentation is already in sync with your code changes. Great job! ðŸŽ‰

            ---
            ðŸ¤– Triggered by the \`pr-beta-docs-sync\` workflow
            `
            });
