name: Update README status badges

on:
  push:
    branches:
      - main
      - beta
    # Only run when the TOC changes
    paths:
      - "SpectrumFederation/SpectrumFederation.toc"
  workflow_run:
    workflows:
      - "Validate WowUp/CurseForge packaging + version"
    types:
      - completed

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.sha }}

      - name: Update badges and version in README
        run: |
          python3 << 'PY'
          from pathlib import Path
          import re

          # ---- 1. Read and parse the TOC ----
          toc_path = Path("SpectrumFederation/SpectrumFederation.toc")
          toc = toc_path.read_text(encoding="utf-8")

          interface_num = None
          version = None

          for chunk in toc.split("##"):
              chunk = chunk.strip()
              if chunk.lower().startswith("interface:"):
                  interface_num = int(chunk.split(":", 1)[1].strip().split()[0])
              if chunk.lower().startswith("version:"):
                  version = chunk.split(":", 1)[1].strip().split()[0]

          if interface_num is None or version is None:
              raise SystemExit("Could not find Interface or Version in TOC")

          # Convert, e.g., 120000 -> 12.0.0
          major = interface_num // 10000
          minor = (interface_num // 100) % 100
          patch = interface_num % 100
          wow_version = f"{major}.{minor}.{patch}"

          # Track from version string
          track = "Beta" if "beta" in version.lower() else "Retail"

          def shields_escape(text: str) -> str:
              # shields static badges: space -> %20, dash -> double dash
              return text.replace(" ", "%20").replace("-", "--")

          wow_label = shields_escape(wow_version)
          track_label = shields_escape(track)
          version_label = shields_escape(version)

          badges_block = f"""<!-- STATUS_BADGES_START -->
          ![WoW Version](https://img.shields.io/badge/WoW-{wow_label}-00aaff)
          ![Track](https://img.shields.io/badge/Track-{track_label}-ff8800)
          ![Addon Version](https://img.shields.io/badge/Version-{version_label}-brightgreen)
          <!-- STATUS_BADGES_END -->
          """

          readme_path = Path("README.md")
          readme = readme_path.read_text(encoding="utf-8")

          # ---- 2. Replace or insert the badges block ----
          pattern_badges = r"<!-- STATUS_BADGES_START -->.*?<!-- STATUS_BADGES_END -->"

          if re.search(pattern_badges, readme, flags=re.S):
              # Replace existing badge block
              readme = re.sub(pattern_badges, badges_block, readme, flags=re.S)
          else:
              # Insert after first line (e.g., your banner image)
              lines = readme.splitlines()
              if lines:
                  insert_at = 1  # after first line
                  lines = (
                      lines[:insert_at]
                      + ["", badges_block, ""]
                      + lines[insert_at:]
                  )
                  readme = "\n".join(lines)
              else:
                  readme = badges_block + "\n"

          # ---- 3. Update the "Current version:" line ----
          pattern_version = r"(Current version:\s*)([^\s<]+)"
          readme, _ = re.subn(pattern_version, r"\g<1>" + version, readme)

          readme_path.write_text(readme, encoding="utf-8")
          PY

      - name: Commit and push changes (if any)
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -am "chore: update README badges [skip ci]"
          git push
          